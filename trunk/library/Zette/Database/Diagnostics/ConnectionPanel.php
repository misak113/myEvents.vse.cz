<?php/** * This file is part of the Nette Framework (http://nette.org) * * Copyright (c) 2004 David Grudl (http://davidgrudl.com) * * For the full copyright and license information, please view * the file license.txt that was distributed with this source code. */namespace Zette\Database\Diagnostics;use Nette,		Nette\Database\Helpers,		Nette\Diagnostics\Debugger;use Zend_Db_Statement_Pdo;use Zend_Db_Profiler;/** * Debug panel for Nette\Database. * * @author     David Grudl */class ConnectionPanel extends Nette\Object implements Nette\Diagnostics\IBarPanel{	/** @var int maximum SQL length */	static public $maxLength = 1000;	/** @var int logged time */	private $totalTime = 0;	/** @var array */	private $queries = array();	/** @var string */	public $name;	/** @var bool|string explain queries? */	public $explain = TRUE;	/** @var bool */	public $disabled = FALSE;	/** @var array */	protected $statements = array();	/** @var Zend_Db_Profiler */	protected $profiler;	public function logQuery(Zend_Db_Statement_Pdo $result)	{		if ($this->disabled) {			return;		}		$source = NULL;		foreach (debug_backtrace(FALSE) as $row) {			if (isset($row['file']) && is_file($row['file']) && strpos($row['file'], NETTE_DIR . DIRECTORY_SEPARATOR) !== 0) {				if (isset($row['function']) && strpos($row['function'], 'call_user_func') === 0) continue;				if (isset($row['class']) && is_subclass_of($row['class'], '\\Nette\\Database\\Connection')) continue;				if (isset($row['class']) && (strpos($row['class'], 'Zette') === 0 || strpos($row['class'], 'Nette') || strpos($row['class'], 'Zend') === 0)) continue;				$source = array($row['file'], (int) $row['line']);				break;			}		}		/** @var \PDOStatement $stmt  */		$stmt = $result->getDriverStatement();		$id = $stmt->queryString;		$this->statements[$id] = array($result, $source);	}	public function setProfiler(\Zend_Db_Profiler $profiler) {		Debugger::$bar->addPanel($this);		$this->profiler = $profiler;	}	protected function queries() {		$queryProfiles = $this->profiler->getQueryProfiles();		$queries = array();		if ($queryProfiles)		/** @var \Zend_Db_Profiler_Query $queryProfile */		foreach ($queryProfiles as $queryProfile) {			$id = $queryProfile->getQuery();			$this->totalTime+= $queryProfile->getElapsedSecs();			if (isset($this->statements[$id])) {				/** @var Zend_Db_Statement_Pdo $stmt */				list($stmt, $source) = $this->statements[$id];				$count = $queryProfile->getQueryType();				$connection = $stmt->getAdapter();			} else {				$count = '-';				$connection = null;				$source = null;			}			$query = array($queryProfile->getQuery(), $queryProfile->getQueryParams(), $queryProfile->getElapsedSecs(), $count, $connection, $source);			$queries[] = $query;		}		return $queries;	}	public static function renderException($e)	{		if ($e instanceof \PDOException && isset($e->queryString)) {			return array(				'tab' => 'SQL',				'panel' => Helpers::dumpSql($e->queryString),			);		}	}	public function getTab()	{		return '<span title="Nette\\Database ' . htmlSpecialChars($this->name) . '">'				. '<img src="data:image/png;base64,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" />'				. count($this->queries()) . ' queries'				. ($this->totalTime ? ' / ' . sprintf('%0.1f', $this->totalTime * 1000) . 'ms' : '')				. '</span>';	}	public function getPanel()	{		$this->disabled = TRUE;		$s = '';		$h = 'htmlSpecialChars';		$queries = $this->queries();		foreach ($queries as $i => $query) {			/** @var \Zend_Db_Adapter_Pdo_Abstract $connection */			list($sql, $params, $time, $rows, $connection, $source) = $query;			$explain = NULL; // EXPLAIN is called here to work SELECT FOUND_ROWS()			if ($this->explain && preg_match('#\s*\(?\s*SELECT\s#iA', $sql) && $connection) {				try {					$cmd = is_string($this->explain) ? $this->explain : 'EXPLAIN';					$explain = $connection->query("$cmd $sql", $params)->fetchAll();				} catch (\PDOException $e) {}			}			$s .= '<tr><td>' . sprintf('%0.3f', $time * 1000);			if ($explain) {				static $counter;				$counter++;				$s .= "<br /><a href='#' class='nette-toggler' rel='#nette-DbConnectionPanel-row-$counter'>explain&nbsp;&#x25ba;</a>";			}			$s .= '</td><td class="nette-DbConnectionPanel-sql">' . Helpers::dumpSql(self::$maxLength ? Nette\Utils\Strings::truncate($sql, self::$maxLength) : $sql);			if ($explain) {				$s .= "<table id='nette-DbConnectionPanel-row-$counter' class='nette-collapsed'><tr>";				foreach ($explain[0] as $col => $foo) {					$s .= "<th>{$h($col)}</th>";				}				$s .= "</tr>";				foreach ($explain as $row) {					$s .= "<tr>";					foreach ($row as $col) {						$s .= "<td>{$h($col)}</td>";					}					$s .= "</tr>";				}				$s .= "</table>";			}			if ($source) {				$s .= Nette\Diagnostics\Helpers::editorLink($source[0], $source[1])->class('nette-DbConnectionPanel-source');			}			$s .= '</td><td>';			foreach ($params as $param) {				$s .= Debugger::dump($param, TRUE);			}			$s .= '</td><td>' . $rows . '</td></tr>';		}		return empty($queries) ? '' :				'<style> #nette-debug td.nette-DbConnectionPanel-sql { background: white !important }			#nette-debug .nette-DbConnectionPanel-source { color: #BBB !important } </style>			<h1>Queries: ' . count($queries) . ($this->totalTime ? ', time: ' . sprintf('%0.3f', $this->totalTime * 1000) . ' ms' : '') . '</h1>			<div class="nette-inner nette-DbConnectionPanel">			<table>				<tr><th>Time&nbsp;ms</th><th>SQL Statement</th><th>Params</th><th>Rows</th></tr>' . $s . '			</table>			</div>';	}}